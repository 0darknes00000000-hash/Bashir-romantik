<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–ª—è –ê–º–∏–Ω—ã</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;1,400&family=Lora:ital,wght@0,400;1,400&family=Raleway:wght@200;300;400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --cream:#f5ede0;--gold:#c8922a;--gold-soft:#ddb96a;
  --brown-dark:#1e0f05;--text:#3a2010;
}
html,body{width:100%;min-height:100vh;overflow-x:hidden;background:#1e0f05;font-family:'Lora',serif;}

/* ======= INTRO ======= */
#intro{
  position:fixed;inset:0;z-index:2000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 50% 40%,#2a1205 0%,#080300 100%);
  cursor:pointer;transition:opacity 1.4s ease;
}
#intro.out{opacity:0;pointer-events:none;}

.intro-name{
  font-family:'EB Garamond',serif;
  font-size:clamp(4rem,18vw,6rem);
  font-style:italic;font-weight:400;
  color:var(--gold-soft);
  letter-spacing:0.1em;
  opacity:0;animation:riseIn 2.5s cubic-bezier(0.16,1,0.3,1) 0.4s forwards;
  text-shadow:0 0 80px rgba(200,146,42,0.4),0 0 160px rgba(200,146,42,0.15);
}
.intro-line{
  height:1px;width:0;
  background:linear-gradient(90deg,transparent,var(--gold-soft),transparent);
  margin:1.2rem auto;
  animation:growLine 1.5s ease 2s forwards;
}
.intro-sub{
  font-family:'Raleway',sans-serif;font-size:0.62rem;font-weight:200;
  letter-spacing:0.5em;text-transform:uppercase;
  color:rgba(200,146,42,0.4);opacity:0;
  animation:riseIn 1.8s ease 2.5s forwards;
}
.intro-hint{
  position:absolute;bottom:2.5rem;
  font-family:'Raleway',sans-serif;font-size:0.58rem;
  letter-spacing:0.35em;text-transform:uppercase;
  color:rgba(255,255,255,0.15);animation:breathe 3s ease 3s infinite;
}
@keyframes riseIn{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
@keyframes growLine{to{width:110px;}}
@keyframes breathe{0%,100%{opacity:0.15;}50%{opacity:0.4;}}

/* ======= SCENE CANVAS ======= */
#bgCanvas{
  position:fixed;inset:0;z-index:0;
  width:100%;height:100%;
  opacity:0;transition:opacity 2s ease;
}
#bgCanvas.on{opacity:1;}

/* ======= PETALS (CSS drawn) ======= */
.sakura-petal{
  position:fixed;pointer-events:none;z-index:6;
  width:10px;height:6px;
  border-radius:50% 50% 50% 0/60% 60% 40% 40%;
  background:radial-gradient(ellipse at 40% 40%,#ffd6e7,#ffb3cf);
  box-shadow:0 0 4px rgba(255,182,215,0.4);
  animation:petalDrift linear forwards;
}
@keyframes petalDrift{
  0%{opacity:0;transform:translate(0,0) rotate(0deg) scale(0.8);}
  8%{opacity:0.85;}90%{opacity:0.4;}
  100%{opacity:0;transform:translate(var(--px),110vh) rotate(var(--pr)) scale(0.6);}
}

/* ======= VIGNETTE ======= */
.vignette{
  position:fixed;inset:0;z-index:5;
  background:radial-gradient(ellipse at 50% 42%,transparent 25%,rgba(10,4,1,0.55) 100%);
  pointer-events:none;
}

/* ======= PAGE ======= */
#page{
  position:relative;z-index:10;
  min-height:100vh;padding-bottom:80px;
  display:flex;flex-direction:column;align-items:center;
  opacity:0;transition:opacity 1.8s ease 0.3s;
}
#page.on{opacity:1;}

/* Dynamic spacer set by JS */
.spacer{min-height:60px;}

/* ======= LETTER ======= */
.letter-wrap{
  width:min(88vw,375px);
  opacity:0;transform:translateY(30px);
  transition:opacity 1.5s cubic-bezier(0.16,1,0.3,1) 0.8s,transform 1.5s cubic-bezier(0.16,1,0.3,1) 0.8s;
}
.letter-wrap.in{opacity:1;transform:translateY(0);}

.letter-card{
  background:#f5ede0;border-radius:4px;
  padding:30px 24px 26px;position:relative;
  border-top:3px solid var(--gold-soft);
  box-shadow:0 2px 0 rgba(200,146,42,0.2),0 12px 40px rgba(20,8,2,0.35),0 30px 80px rgba(20,8,2,0.15);
  user-select:none;-webkit-user-select:none;
}
.letter-card::before{
  content:'';position:absolute;inset:0;
  background-image:repeating-linear-gradient(transparent,transparent 28px,rgba(160,100,42,0.05) 28px,rgba(160,100,42,0.05) 29px);
  border-radius:4px;pointer-events:none;
}
.letter-greeting{
  font-family:'EB Garamond',serif;font-size:1.6rem;font-style:italic;
  color:var(--gold);margin-bottom:18px;position:relative;z-index:1;
}
.letter-body{
  font-family:'Lora',serif;font-size:0.91rem;line-height:2;
  color:var(--text);position:relative;z-index:1;min-height:160px;
}
.letter-body p+p{margin-top:14px;}
.ornament{text-align:center;color:var(--gold-soft);font-size:0.75rem;letter-spacing:0.5em;margin:16px 0;opacity:0.55;}
.cursor{display:inline-block;width:2px;height:1em;background:var(--gold);margin-left:2px;vertical-align:middle;animation:curBlink 0.8s infinite;}
@keyframes curBlink{0%,100%{opacity:1;}50%{opacity:0;}}

.ps-hint{
  text-align:center;margin-top:14px;
  font-family:'Raleway',sans-serif;font-size:0.62rem;font-weight:200;
  letter-spacing:0.2em;color:rgba(160,100,42,0.4);
  opacity:0;transition:opacity 1s ease;position:relative;z-index:1;
}
.ps-hint.show{opacity:1;}

#ps-overlay{
  position:absolute;inset:0;border-radius:4px;
  background:rgba(245,237,224,0.97);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:28px;opacity:0;pointer-events:none;
  transition:opacity 0.6s ease;z-index:10;
}
#ps-overlay.show{opacity:1;pointer-events:all;}
.ps-title{font-family:'EB Garamond',serif;font-size:1.6rem;font-style:italic;color:var(--gold);margin-bottom:14px;}
.ps-text{font-family:'Lora',serif;font-size:0.85rem;font-style:italic;line-height:1.9;color:var(--text);text-align:center;}
.ps-close{margin-top:18px;font-family:'Raleway',sans-serif;font-size:0.62rem;letter-spacing:0.3em;color:var(--gold-soft);background:none;border:none;cursor:pointer;text-transform:uppercase;}

/* ======= QUESTION ======= */
.q-section{
  width:min(88vw,375px);margin-top:28px;
  opacity:0;transform:translateY(22px);
  transition:opacity 1.2s ease 1.6s,transform 1.2s ease 1.6s;
}
.q-section.in{opacity:1;transform:translateY(0);}
.q-text{
  font-family:'EB Garamond',serif;font-size:1.12rem;font-style:italic;
  color:var(--cream);line-height:1.8;text-align:center;
  text-shadow:0 2px 14px rgba(0,0,0,0.6);margin-bottom:28px;padding:0 8px;
}
.btns{position:relative;width:100%;height:140px;}
.btn-yes{
  position:absolute;left:50%;top:10px;transform:translateX(-50%);
  background:linear-gradient(135deg,#c8922a,#a87020);
  color:var(--cream);border:none;border-radius:50px;
  padding:17px 52px;font-family:'EB Garamond',serif;
  font-size:1.1rem;font-style:italic;letter-spacing:0.08em;
  cursor:pointer;width:210px;z-index:2;
  box-shadow:0 5px 22px rgba(200,146,42,0.4),inset 0 1px 0 rgba(255,255,255,0.18);
  transition:transform 0.2s;
}
.btn-yes:active{transform:translateX(-50%) scale(0.96);}
.btn-no{
  position:absolute;left:50%;bottom:10px;transform:translateX(-50%);
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.45);
  border:1px solid rgba(255,255,255,0.2);border-radius:50px;
  padding:12px 36px;font-family:'Raleway',sans-serif;
  font-size:0.78rem;font-weight:300;letter-spacing:0.12em;
  cursor:pointer;width:148px;z-index:2;
  transition:all 0.55s cubic-bezier(0.34,1.56,0.64,1);
}

/* ======= YES SCREEN ======= */
#yes-screen{
  position:fixed;inset:0;z-index:800;
  background:radial-gradient(ellipse at 50% 40%,#2e1506,#0a0300);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:44px;
  opacity:0;pointer-events:none;transition:opacity 1.3s ease;
}
#yes-screen.on{opacity:1;pointer-events:all;}
.yes-glow{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 50%,rgba(200,146,42,0.1),transparent 65%);animation:glowB 4s ease-in-out infinite;}
@keyframes glowB{0%,100%{opacity:0.6;}50%{opacity:1;}}
.yes-icon{font-size:3rem;margin-bottom:22px;opacity:0;transform:scale(0.3);transition:opacity 0.9s ease 0.3s,transform 0.9s cubic-bezier(0.34,1.56,0.64,1) 0.3s;}
#yes-screen.on .yes-icon{opacity:1;transform:scale(1);}
.yes-title{font-family:'EB Garamond',serif;font-size:2rem;font-style:italic;color:var(--gold-soft);margin-bottom:16px;line-height:1.35;opacity:0;transform:translateY(14px);transition:opacity 1s ease 0.8s,transform 1s ease 0.8s;text-shadow:0 0 50px rgba(200,146,42,0.4);}
#yes-screen.on .yes-title{opacity:1;transform:translateY(0);}
.yes-body{font-family:'Lora',serif;font-size:0.88rem;font-style:italic;color:rgba(245,220,165,0.7);line-height:1.9;max-width:285px;opacity:0;transform:translateY(12px);transition:opacity 1s ease 1.2s,transform 1s ease 1.2s;}
#yes-screen.on .yes-body{opacity:1;transform:translateY(0);}

/* ======= PARTICLES ======= */
.confetti-p{position:fixed;pointer-events:none;z-index:900;animation:cfFall linear forwards;}
@keyframes cfFall{0%{opacity:1;transform:translateY(-10px) rotate(0deg);}100%{opacity:0;transform:translateY(105vh) rotate(var(--cr));}}
.shard-p{position:fixed;pointer-events:none;z-index:900;border-radius:2px;animation:shardOut ease-out forwards;}
@keyframes shardOut{0%{opacity:0.85;transform:translate(0,0) rotate(0deg) scale(1);}100%{opacity:0;transform:translate(var(--sx),var(--sy)) rotate(var(--sr)) scale(0);}}
.bloom-petal{
  position:fixed;pointer-events:none;z-index:6;
  width:12px;height:7px;
  border-radius:50% 50% 50% 0/60% 60% 40% 40%;
  background:radial-gradient(ellipse at 40% 40%,#ffd6e7,#ff90ba);
  box-shadow:0 0 6px rgba(255,150,186,0.5);
  animation:bloomFall linear forwards;
}
@keyframes bloomFall{
  0%{opacity:0;transform:translate(0,0) rotate(0deg);}
  6%{opacity:1;}92%{opacity:0.7;}
  100%{opacity:0;transform:translate(var(--bx),110vh) rotate(var(--br));}
}
</style>
</head>
<body>

<!-- AUDIO -->
<audio id="bgMusic" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg">
  <source src="music.ogg" type="audio/ogg">
</audio>

<!-- INTRO -->
<div id="intro" onclick="begin()">
  <div class="intro-name">–ê–º–∏–Ω–∞</div>
  <div class="intro-line"></div>
  <div class="intro-sub">—ç—Ç–æ –¥–ª—è —Ç–µ–±—è</div>
  <div class="intro-hint">–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
</div>

<!-- CANVAS BACKGROUND -->
<canvas id="bgCanvas"></canvas>
<div class="vignette"></div>

<!-- PAGE -->
<div id="page" onclick="onTap(event)">
  <div class="spacer" id="spacer"></div>

  <div class="letter-wrap" id="lw">
    <div class="letter-card" id="letterCard"
         ontouchstart="startHold()" ontouchend="endHold()" ontouchcancel="endHold()"
         onmousedown="startHold()" onmouseup="endHold()" onmouseleave="endHold()">
      <div class="letter-greeting">–ê–º–∏–Ω–∞,</div>
      <div class="letter-body" id="letterBody">
        <span id="typeTarget"></span><span class="cursor" id="cursor"></span>
      </div>
      <div class="ps-hint" id="psHint">—É–¥–µ—Ä–∂–∏ –ø–∏—Å—å–º–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–æ–µ-—á—Ç–æ –µ—â—ë...</div>
      <div id="ps-overlay">
        <div class="ps-title">P.S.</div>
        <div class="ps-text">–ó–Ω–∞–µ—à—å, —è –Ω–µ —É–º–µ—é –∫—Ä–∞—Å–∏–≤–æ –≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö.<br>–ù–æ –∫–æ–≥–¥–∞ —á–∏—Ç–∞—é ‚Äî –Ω–∞—Ö–æ–∂—É —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É—é.<br><br>–¢—ã ‚Äî –º–æ—è –ª—é–±–∏–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞.</div>
        <button class="ps-close" onclick="closePS(event)">–∑–∞–∫—Ä—ã—Ç—å ‚úï</button>
      </div>
    </div>
  </div>

  <div class="q-section" id="qs">
    <div class="q-text">–†–∞–∑–¥–µ–ª—è–µ—à—å –ª–∏ —Ç—ã –º–æ–∏ —á—É–≤—Å—Ç–≤–∞,<br>–∏ –≥–æ—Ç–æ–≤–∞ –ª–∏ —Ç—ã –∫ –Ω–æ–≤–æ–º—É —ç—Ç–∞–ø—É –º–µ–∂–¥—É –Ω–∞–º–∏?</div>
    <div class="btns" id="btnBox">
      <button class="btn-yes" onclick="handleYes(event)">–î–∞ ‚ô°</button>
      <button class="btn-no" id="btnNo" onclick="handleNo(event)">–ù–µ—Ç</button>
    </div>
  </div>
</div>

<!-- YES SCREEN -->
<div id="yes-screen">
  <div class="yes-glow"></div>
  <div class="yes-icon">üå∏</div>
  <div class="yes-title">–≠—Ç–æ –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≤–µ—Ç–µ</div>
  <div class="yes-body">–ó–Ω–∞—á–∏—Ç, –Ω–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è.<br>–ò —è –æ–±–µ—â–∞—é ‚Äî –æ–Ω–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ –ª—é–±–æ–π –∫–Ω–∏–≥–∏.</div>
</div>

<script>
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let W, H, animFrame;
let petalAngle = 0;

// ===== RESIZE =====
function resize(){
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  drawScene();
  document.getElementById('spacer').style.height = (windowH() * 0.52 + 30) + 'px';
}
function windowH(){ return window.innerHeight; }
window.addEventListener('resize', resize);

// ===== TIME OF DAY =====
function getTOD(){
  const h = new Date().getHours();
  if(h>=5&&h<8) return 'dawn';
  if(h>=8&&h<18) return 'day';
  if(h>=18&&h<21) return 'dusk';
  return 'night';
}

function getSkyColors(){
  const tod = getTOD();
  if(tod==='dawn') return {top:'#f4a27a',mid:'#f7c580',bot:'#c8e8a0',treeCol:'#2a5a20'};
  if(tod==='day')  return {top:'#7ec8f0',mid:'#b0ddf5',bot:'#c8f0d0',treeCol:'#2a6a1a'};
  if(tod==='dusk') return {top:'#c05020',mid:'#e08040',bot:'#604030',treeCol:'#1a3a10'};
  return {top:'#0a0818',mid:'#12102a',bot:'#1a1830',treeCol:'#0a1a08'};
}

// ===== MAIN DRAW =====
function drawScene(){
  if(!W) return;
  ctx.clearRect(0,0,W,H);
  drawRoom();
  drawWindow();
  drawSill();
  drawCoffeeCup();
  drawCat();
  drawBookShelves();
}

// --- ROOM WALLS ---
function drawRoom(){
  const tod = getTOD();
  // Wall gradient
  const wallG = ctx.createLinearGradient(0,0,W,H);
  if(tod==='night'){
    wallG.addColorStop(0,'#3a2510');
    wallG.addColorStop(0.5,'#2a1a08');
    wallG.addColorStop(1,'#180e04');
  } else if(tod==='dusk'){
    wallG.addColorStop(0,'#7a4a28');
    wallG.addColorStop(0.5,'#5a3018');
    wallG.addColorStop(1,'#3a1a08');
  } else {
    wallG.addColorStop(0,'#c8a070');
    wallG.addColorStop(0.4,'#b08050');
    wallG.addColorStop(1,'#7a5030');
  }
  ctx.fillStyle = wallG;
  ctx.fillRect(0,0,W,H);

  // Subtle warm light from window
  const winCx = W/2, winCy = H*0.22;
  const lightR = ctx.createRadialGradient(winCx,winCy,10,winCx,winCy,W*0.75);
  if(tod==='night'){
    lightR.addColorStop(0,'rgba(150,130,200,0.12)');
  } else if(tod==='dusk'){
    lightR.addColorStop(0,'rgba(255,160,80,0.18)');
  } else {
    lightR.addColorStop(0,'rgba(255,230,160,0.22)');
  }
  lightR.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = lightR;
  ctx.fillRect(0,0,W,H);

  // Wood floor
  const floorY = H*0.78;
  const floorG = ctx.createLinearGradient(0,floorY,0,H);
  floorG.addColorStop(0,'#6a3e18');
  floorG.addColorStop(0.3,'#4a2a0c');
  floorG.addColorStop(1,'#2a1408');
  ctx.fillStyle = floorG;
  ctx.fillRect(0,floorY,W,H-floorY);

  // Floor planks
  ctx.strokeStyle = 'rgba(0,0,0,0.12)';
  ctx.lineWidth = 1;
  for(let x=0; x<W; x+=W/5){
    ctx.beginPath();
    ctx.moveTo(x,floorY);
    ctx.lineTo(x+W*0.1,H);
    ctx.stroke();
  }

  // Baseboard
  const bbG = ctx.createLinearGradient(0,floorY-6,0,floorY+2);
  bbG.addColorStop(0,'#3a1a08');
  bbG.addColorStop(1,'#200e04');
  ctx.fillStyle = bbG;
  ctx.fillRect(0,floorY-6,W,8);
}

// --- WINDOW ---
function drawWindow(){
  const sc = getSkyColors();
  const tod = getTOD();
  const wW = W*0.82, wH = H*0.44;
  const wX = (W-wW)/2, wY = H*0.04;
  const frameW = 14;

  // Sky gradient inside window
  const skyG = ctx.createLinearGradient(wX,wY,wX,wY+wH);
  skyG.addColorStop(0, sc.top);
  skyG.addColorStop(0.5, sc.mid);
  skyG.addColorStop(1, sc.bot);
  ctx.save();
  roundRect(ctx, wX+frameW, wY+frameW, wW-frameW*2, wH-frameW*2, 3);
  ctx.clip();
  ctx.fillStyle = skyG;
  ctx.fillRect(wX,wY,wW,wH);

  // Stars at night
  if(tod==='night'){
    ctx.fillStyle = 'white';
    for(let i=0;i<55;i++){
      const sx = wX+frameW + Math.abs(Math.sin(i*137.5)*3.7%1)*(wW-frameW*2);
      const sy = wY+frameW + Math.abs(Math.cos(i*97.3)*2.1%1)*(wH*0.55);
      const sr = 0.5+Math.abs(Math.sin(i*53.7))*1.2;
      ctx.globalAlpha = 0.4+Math.abs(Math.sin(i*0.7+petalAngle*2))*0.5;
      ctx.beginPath();
      ctx.arc(sx,sy,sr,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // Moon
    const moonX = wX+wW*0.75, moonY = wY+wH*0.2;
    const moonG = ctx.createRadialGradient(moonX-5,moonY-5,2,moonX,moonY,22);
    moonG.addColorStop(0,'#fffde0');
    moonG.addColorStop(0.7,'#e8d890');
    moonG.addColorStop(1,'rgba(232,216,144,0)');
    ctx.fillStyle = moonG;
    ctx.beginPath();
    ctx.arc(moonX,moonY,22,0,Math.PI*2);
    ctx.fill();
    // Glow
    ctx.fillStyle = 'rgba(255,240,160,0.08)';
    ctx.beginPath();
    ctx.arc(moonX,moonY,40,0,Math.PI*2);
    ctx.fill();
  }

  // Clouds (day/dawn/dusk)
  if(tod!=='night'){
    drawClouds(wX+frameW, wY+frameW, wW-frameW*2, wH*0.5);
  }

  // Sakura tree
  drawSakuraTree(wX+frameW, wY+frameW, wW-frameW*2, wH-frameW*2, sc.treeCol);

  ctx.restore();

  // Window frame (wood)
  const frameG = ctx.createLinearGradient(wX,0,wX+frameW,0);
  frameG.addColorStop(0,'#4a2408');
  frameG.addColorStop(0.5,'#6b3a14');
  frameG.addColorStop(1,'#4a2408');
  ctx.fillStyle = frameG;
  // Outer frame
  ctx.fillRect(wX, wY, wW, frameW); // top
  ctx.fillRect(wX, wY+wH-frameW, wW, frameW); // bottom
  ctx.fillRect(wX, wY, frameW, wH); // left
  ctx.fillRect(wX+wW-frameW, wY, frameW, wH); // right
  // Cross
  ctx.fillRect(wX+frameW, wY+wH/2-5, wW-frameW*2, 10); // horizontal
  ctx.fillRect(wX+wW/2-5, wY+frameW, 10, wH-frameW*2); // vertical

  // Frame highlight
  ctx.strokeStyle = 'rgba(255,200,120,0.15)';
  ctx.lineWidth = 1;
  ctx.strokeRect(wX+1,wY+1,wW-2,wH-2);

  // Glass shimmer
  ctx.save();
  roundRect(ctx,wX+frameW,wY+frameW,wW-frameW*2,wH-frameW*2,3);
  ctx.clip();
  const shimG = ctx.createLinearGradient(wX,wY,wX+wW,wY+wH);
  shimG.addColorStop(0,'rgba(255,255,255,0.08)');
  shimG.addColorStop(0.4,'rgba(255,255,255,0.02)');
  shimG.addColorStop(1,'rgba(255,255,255,0.05)');
  ctx.fillStyle = shimG;
  ctx.fillRect(wX,wY,wW,wH);
  ctx.restore();

  // Curtains
  drawCurtains(wX, wY, wW, wH, frameW);
}

function drawClouds(cx,cy,cw,ch){
  ctx.fillStyle = 'rgba(255,255,255,0.75)';
  const clouds = [{x:0.15,y:0.2,w:0.25,h:0.1},{x:0.55,y:0.1,w:0.3,h:0.12},{x:0.7,y:0.3,w:0.2,h:0.08}];
  clouds.forEach(c=>{
    const cloudX = cx+c.x*cw, cloudY = cy+c.y*ch;
    const cloudW = c.w*cw, cloudH = c.h*ch;
    ctx.save();
    ctx.filter = 'blur(4px)';
    ctx.beginPath();
    ctx.ellipse(cloudX,cloudY,cloudW/2,cloudH/2,0,0,Math.PI*2);
    ctx.fill();
    ctx.filter = 'none';
    ctx.restore();
  });
}

// --- SAKURA TREE ---
function drawSakuraTree(x,y,w,h,trunkCol){
  const trunkX = x + w*0.65;
  const groundY = y + h;
  const trunkH = h*0.62;
  const trunkW = w*0.04;

  // Trunk
  ctx.save();
  const trunkG = ctx.createLinearGradient(trunkX-trunkW,0,trunkX+trunkW,0);
  trunkG.addColorStop(0,'#3a2010');
  trunkG.addColorStop(0.4,'#5a3520');
  trunkG.addColorStop(1,'#2a1508');
  ctx.fillStyle = trunkG;
  ctx.beginPath();
  ctx.moveTo(trunkX-trunkW, groundY);
  ctx.quadraticCurveTo(trunkX-trunkW*0.5, groundY-trunkH*0.6, trunkX-trunkW*0.3, groundY-trunkH);
  ctx.quadraticCurveTo(trunkX+trunkW*0.3, groundY-trunkH, trunkX+trunkW*0.5, groundY-trunkH*0.6);
  ctx.quadraticCurveTo(trunkX+trunkW, groundY-trunkH*0.2, trunkX+trunkW, groundY);
  ctx.closePath();
  ctx.fill();

  // Branches
  drawBranch(ctx, trunkX, groundY-trunkH, trunkX-w*0.28, groundY-trunkH*1.08, trunkW*0.6);
  drawBranch(ctx, trunkX, groundY-trunkH*0.75, trunkX+w*0.2, groundY-trunkH*0.95, trunkW*0.5);
  drawBranch(ctx, trunkX-trunkW*0.3, groundY-trunkH*0.85, trunkX-w*0.22, groundY-trunkH*1.15, trunkW*0.4);
  drawBranch(ctx, trunkX, groundY-trunkH*0.55, trunkX-w*0.15, groundY-trunkH*0.75, trunkW*0.35);

  ctx.restore();

  // Blossoms (clusters)
  drawBlossomClusters(x,y,w,h,trunkX,groundY-trunkH);
}

function drawBranch(ctx, x1,y1,x2,y2,thick){
  const g = ctx.createLinearGradient(x1,y1,x2,y2);
  g.addColorStop(0,'#5a3520');
  g.addColorStop(1,'#3a2010');
  ctx.strokeStyle = g;
  ctx.lineWidth = thick;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  const mx = (x1+x2)/2 + (y2-y1)*0.2;
  const my = (y1+y2)/2 + (x1-x2)*0.1;
  ctx.quadraticCurveTo(mx,my,x2,y2);
  ctx.stroke();
}

function drawBlossomClusters(wx,wy,ww,wh,trunkX,topY){
  const clusters = [
    {x:trunkX-ww*0.28,y:topY,r:ww*0.18},
    {x:trunkX-ww*0.12,y:topY-wh*0.08,r:ww*0.15},
    {x:trunkX+ww*0.22,y:topY+wh*0.05,r:ww*0.16},
    {x:trunkX-ww*0.2,y:topY+wh*0.12,r:ww*0.12},
    {x:trunkX+ww*0.05,y:topY+wh*0.18,r:ww*0.1},
    {x:trunkX-ww*0.3,y:topY+wh*0.22,r:ww*0.09},
  ];
  clusters.forEach(c=>{
    // Shadow/depth first
    const shadowG = ctx.createRadialGradient(c.x,c.y,0,c.x,c.y,c.r);
    shadowG.addColorStop(0,'rgba(200,100,130,0.35)');
    shadowG.addColorStop(0.6,'rgba(255,180,200,0.25)');
    shadowG.addColorStop(1,'rgba(255,200,220,0)');
    ctx.fillStyle = shadowG;
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.r*1.2,0,Math.PI*2);
    ctx.fill();

    // Blossom cluster
    const blG = ctx.createRadialGradient(c.x-c.r*0.2,c.y-c.r*0.2,0,c.x,c.y,c.r);
    blG.addColorStop(0,'rgba(255,215,230,0.92)');
    blG.addColorStop(0.5,'rgba(255,185,210,0.8)');
    blG.addColorStop(0.8,'rgba(240,160,190,0.65)');
    blG.addColorStop(1,'rgba(220,130,165,0)');
    ctx.fillStyle = blG;
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.r,0,Math.PI*2);
    ctx.fill();

    // Individual petals hint
    for(let i=0;i<7;i++){
      const angle = (i/7)*Math.PI*2 + petalAngle*0.5;
      const px = c.x + Math.cos(angle)*c.r*0.55;
      const py = c.y + Math.sin(angle)*c.r*0.55;
      const pr = c.r*0.22;
      const pG = ctx.createRadialGradient(px,py,0,px,py,pr);
      pG.addColorStop(0,'rgba(255,230,240,0.7)');
      pG.addColorStop(1,'rgba(255,180,210,0)');
      ctx.fillStyle = pG;
      ctx.beginPath();
      ctx.arc(px,py,pr,0,Math.PI*2);
      ctx.fill();
    }
  });
}

// --- CURTAINS ---
function drawCurtains(wX,wY,wW,wH,fw){
  // Left curtain
  ctx.save();
  const lCurtW = wW*0.2;
  const lG = ctx.createLinearGradient(wX,0,wX+lCurtW*1.5,0);
  lG.addColorStop(0,'rgba(245,230,200,0.88)');
  lG.addColorStop(0.5,'rgba(235,215,185,0.65)');
  lG.addColorStop(1,'rgba(225,205,175,0)');
  ctx.fillStyle = lG;
  ctx.beginPath();
  ctx.moveTo(wX+fw, wY+fw);
  ctx.quadraticCurveTo(wX+lCurtW*0.7, wY+wH*0.3, wX+lCurtW*0.6, wY+wH*0.5);
  ctx.quadraticCurveTo(wX+lCurtW*0.7, wY+wH*0.7, wX+lCurtW*0.5, wY+wH-fw);
  ctx.lineTo(wX+fw, wY+wH-fw);
  ctx.closePath();
  ctx.fill();
  // Fabric folds
  for(let i=1;i<4;i++){
    ctx.strokeStyle = 'rgba(200,170,130,0.2)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(wX+fw+i*8, wY+fw);
    ctx.quadraticCurveTo(wX+fw+i*8-4, wY+wH*0.5, wX+fw+i*6, wY+wH-fw);
    ctx.stroke();
  }
  ctx.restore();

  // Right curtain
  ctx.save();
  const rCurtW = wW*0.2;
  const rX = wX+wW-fw;
  const rG = ctx.createLinearGradient(rX,0,rX-rCurtW*1.5,0);
  rG.addColorStop(0,'rgba(245,230,200,0.88)');
  rG.addColorStop(0.5,'rgba(235,215,185,0.65)');
  rG.addColorStop(1,'rgba(225,205,175,0)');
  ctx.fillStyle = rG;
  ctx.beginPath();
  ctx.moveTo(rX, wY+fw);
  ctx.quadraticCurveTo(rX-rCurtW*0.7, wY+wH*0.3, rX-rCurtW*0.6, wY+wH*0.5);
  ctx.quadraticCurveTo(rX-rCurtW*0.7, wY+wH*0.7, rX-rCurtW*0.5, wY+wH-fw);
  ctx.lineTo(rX, wY+wH-fw);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

// --- WINDOWSILL ---
function drawSill(){
  const wW = W*0.82;
  const wX = (W-wW)/2;
  const wY = H*0.04;
  const wH = H*0.44;
  const sillY = wY+wH;
  const sillW = wW + 20;
  const sillH = 16;

  const sillG = ctx.createLinearGradient(0,sillY,0,sillY+sillH);
  sillG.addColorStop(0,'#a07040');
  sillG.addColorStop(0.4,'#7a5028');
  sillG.addColorStop(1,'#5a3818');
  ctx.fillStyle = sillG;
  roundRect(ctx, wX-10, sillY, sillW, sillH, 2);
  ctx.fill();
  // Highlight
  ctx.fillStyle = 'rgba(255,200,120,0.12)';
  ctx.fillRect(wX-10, sillY, sillW, 2);

  // Shadow under sill
  const shadowG = ctx.createLinearGradient(0,sillY+sillH,0,sillY+sillH+20);
  shadowG.addColorStop(0,'rgba(0,0,0,0.25)');
  shadowG.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = shadowG;
  ctx.fillRect(wX-10, sillY+sillH, sillW, 20);
}

// --- CSS COFFEE CUP (drawn on canvas) ---
function drawCoffeeCup(){
  const wW = W*0.82;
  const wX = (W-wW)/2;
  const wY = H*0.04 + H*0.44;
  const cupX = W/2 - 55;
  const cupY = wY - 8;
  const scale = Math.min(W/375, 1.2);

  ctx.save();
  ctx.translate(cupX, cupY);
  ctx.scale(scale, scale);

  // Steam
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  const steamAnim = Math.sin(petalAngle * 2) * 3;
  for(let i=0;i<3;i++){
    const sx = 14 + i*10;
    ctx.save();
    ctx.globalAlpha = 0.3 + Math.abs(Math.sin(petalAngle*2 + i*1.2))*0.3;
    ctx.beginPath();
    ctx.moveTo(sx, -5);
    ctx.quadraticCurveTo(sx + steamAnim + (i-1)*4, -14, sx - (i-1)*3, -22);
    ctx.stroke();
    ctx.restore();
  }

  // Saucer
  ctx.fillStyle = '#e8d0b0';
  ctx.beginPath();
  ctx.ellipse(18, 32, 26, 5, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = '#d4b890';
  ctx.beginPath();
  ctx.ellipse(18, 32, 26, 5, 0, 0, Math.PI);
  ctx.fill();

  // Cup body
  const cupG = ctx.createLinearGradient(-10,0,36,0);
  cupG.addColorStop(0,'#d4b080');
  cupG.addColorStop(0.3,'#e8c898');
  cupG.addColorStop(0.7,'#e0c090');
  cupG.addColorStop(1,'#b89060');
  ctx.fillStyle = cupG;
  ctx.beginPath();
  ctx.moveTo(-4, 5);
  ctx.bezierCurveTo(-6, 20, -4, 30, 2, 32);
  ctx.lineTo(34, 32);
  ctx.bezierCurveTo(40, 30, 42, 20, 40, 5);
  ctx.closePath();
  ctx.fill();

  // Coffee surface
  const coffeeG = ctx.createRadialGradient(18,8,2,18,8,16);
  coffeeG.addColorStop(0,'#6b3a15');
  coffeeG.addColorStop(0.6,'#4a2408');
  coffeeG.addColorStop(1,'#3a1a06');
  ctx.fillStyle = coffeeG;
  ctx.beginPath();
  ctx.ellipse(18, 8, 20, 5, 0, 0, Math.PI*2);
  ctx.fill();
  // Crema swirl
  ctx.strokeStyle = 'rgba(200,160,80,0.4)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(18,8,8,0.5,2.8);
  ctx.stroke();

  // Handle
  ctx.strokeStyle = '#c8a870';
  ctx.lineWidth = 4;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.arc(40, 18, 9, -0.6, 0.6*Math.PI, false);
  ctx.stroke();

  ctx.restore();
}

// --- CSS CAT (drawn on canvas) ---
function drawCat(){
  const wW = W*0.82;
  const wX = (W-wW)/2;
  const sillY = H*0.04 + H*0.44;
  const catX = W/2 + 30;
  const catY = sillY - 4;
  const scale = Math.min(W/375,1.2);
  const bob = Math.sin(petalAngle*0.8)*2;

  ctx.save();
  ctx.translate(catX, catY + bob);
  ctx.scale(scale, scale);

  // Tail
  ctx.strokeStyle = '#c8922a';
  ctx.lineWidth = 5;
  ctx.lineCap = 'round';
  ctx.save();
  ctx.globalAlpha = 0.9;
  const tailWag = Math.sin(petalAngle*1.5)*15;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.quadraticCurveTo(-10+tailWag, -15, -5+tailWag, -28);
  ctx.stroke();
  ctx.restore();

  // Body
  const bodyG = ctx.createRadialGradient(0,-18,2,0,-18,22);
  bodyG.addColorStop(0,'#e8aa50');
  bodyG.addColorStop(0.6,'#c88828');
  bodyG.addColorStop(1,'#a86818');
  ctx.fillStyle = bodyG;
  ctx.beginPath();
  ctx.ellipse(0,-18,16,18,0,0,Math.PI*2);
  ctx.fill();

  // Head
  const headG = ctx.createRadialGradient(-2,-44,2,-2,-44,16);
  headG.addColorStop(0,'#eab858');
  headG.addColorStop(0.6,'#c88828');
  headG.addColorStop(1,'#a86818');
  ctx.fillStyle = headG;
  ctx.beginPath();
  ctx.arc(-2,-44,16,0,Math.PI*2);
  ctx.fill();

  // Ears
  ctx.fillStyle = '#c88828';
  ctx.beginPath();
  ctx.moveTo(-14,-54); ctx.lineTo(-18,-66); ctx.lineTo(-8,-56); ctx.closePath(); ctx.fill();
  ctx.beginPath();
  ctx.moveTo(10,-54); ctx.lineTo(14,-66); ctx.lineTo(4,-56); ctx.closePath(); ctx.fill();
  // Inner ear
  ctx.fillStyle = 'rgba(220,150,150,0.5)';
  ctx.beginPath();
  ctx.moveTo(-13,-55); ctx.lineTo(-16,-63); ctx.lineTo(-9,-57); ctx.closePath(); ctx.fill();
  ctx.beginPath();
  ctx.moveTo(9,-55); ctx.lineTo(12,-63); ctx.lineTo(5,-57); ctx.closePath(); ctx.fill();

  // Eyes
  const blinkVal = Math.abs(Math.sin(petalAngle*0.3));
  const eyeScaleY = blinkVal < 0.05 ? 0.08 : 1;
  ctx.fillStyle = '#1a0a02';
  ctx.save();
  ctx.translate(-6,-45);
  ctx.scale(1, eyeScaleY);
  ctx.beginPath(); ctx.ellipse(0,0,4,4.5,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.save();
  ctx.translate(6,-45);
  ctx.scale(1,eyeScaleY);
  ctx.beginPath(); ctx.ellipse(0,0,4,4.5,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
  // Eye shine
  if(eyeScaleY > 0.5){
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.beginPath(); ctx.arc(-5,-46,1.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(7,-46,1.5,0,Math.PI*2); ctx.fill();
  }

  // Nose
  ctx.fillStyle = '#c86080';
  ctx.beginPath();
  ctx.moveTo(-2,-42); ctx.lineTo(1,-40); ctx.lineTo(-5,-40); ctx.closePath(); ctx.fill();

  // Whiskers
  ctx.strokeStyle = 'rgba(255,240,200,0.6)';
  ctx.lineWidth = 0.8;
  ctx.lineCap = 'round';
  [[-12,-41,-22,-38],[- 12,-40,-22,-41],[-12,-42,-22,-44],
   [6,-41,16,-38],[6,-40,16,-41],[6,-42,16,-44]].forEach(([x1,y1,x2,y2])=>{
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  });

  // Paws
  ctx.fillStyle = '#c88828';
  ctx.beginPath(); ctx.ellipse(-8,0,7,4,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(8,0,7,4,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = 'rgba(220,160,80,0.4)';
  for(let i=-1;i<=1;i++){
    ctx.beginPath(); ctx.ellipse(-8+i*4,1,2,2.5,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(8+i*4,1,2,2.5,0,0,Math.PI*2); ctx.fill();
  }

  ctx.restore();
}

// --- BOOKSHELVES ---
const bookData = [];
function initBooks(){
  const colors = [
    '#8B3A3A','#5C4033','#2E4A6B','#4A6741','#7D5A2E',
    '#6B3D5C','#3D5C6B','#8B6914','#4A3D6B','#6B4A3D',
    '#2E5C4A','#8B5C3A','#5C3A6B','#3A6B5C','#6B2E2E',
    '#4A6B3A','#8B7355','#3D3D6B','#5C6B3A','#7a4a20',
    '#c04040','#405080','#508040','#806040','#604080',
  ];
  bookData.length=0;
  for(let shelf=0;shelf<2;shelf++){
    let x=0;
    while(x<W+10){
      if(Math.random()<0.05&&x>20){
        bookData.push({shelf,x,type:'deco',w:16});
        x+=18;
      } else {
        const h = 36+Math.random()*28;
        const w = 9+Math.random()*8;
        const col = colors[Math.floor(Math.random()*colors.length)];
        const dark = Math.random()>0.45;
        bookData.push({shelf,x,type:'book',w,h,col,dark});
        x+=w+1;
      }
    }
  }
}
initBooks();

const candleFlicker = {x:0,phase:0};

function drawBookShelves(){
  const shelfH = H*0.12;
  const shelfY1 = H*0.78 - shelfH*2 - 14;
  const shelfY2 = shelfY1 + shelfH + 14;
  const boardH = 8;

  [shelfY1, shelfY2].forEach((sy,si)=>{
    // Shelf board
    const sbG = ctx.createLinearGradient(0,sy+shelfH-boardH,0,sy+shelfH);
    sbG.addColorStop(0,'#6b3d1e');
    sbG.addColorStop(1,'#3a1e08');
    ctx.fillStyle = sbG;
    ctx.fillRect(0, sy+shelfH-boardH, W, boardH);
    ctx.fillStyle = 'rgba(255,180,80,0.08)';
    ctx.fillRect(0, sy+shelfH-boardH, W, 1);

    // Shadow on wall above shelf
    const wallShadow = ctx.createLinearGradient(0,sy-10,0,sy+10);
    wallShadow.addColorStop(0,'rgba(0,0,0,0)');
    wallShadow.addColorStop(1,'rgba(0,0,0,0.18)');
    ctx.fillStyle = wallShadow;
    ctx.fillRect(0,sy+shelfH-boardH-10,W,10);

    // Books on this shelf
    bookData.filter(b=>b.shelf===si).forEach(b=>{
      if(b.type==='deco'){
        // Draw a candle
        drawCandle(b.x+6, sy+shelfH-boardH);
      } else {
        const by = sy+shelfH-boardH-b.h;
        // Book spine gradient
        const bookG = ctx.createLinearGradient(b.x,0,b.x+b.w,0);
        bookG.addColorStop(0, shadeColor(b.col,-30));
        bookG.addColorStop(0.25, b.col);
        bookG.addColorStop(0.75, b.col);
        bookG.addColorStop(1, shadeColor(b.col,-40));
        ctx.fillStyle = bookG;
        roundRect(ctx,b.x,by,b.w,b.h,1);
        ctx.fill();
        // Page edges (top)
        ctx.fillStyle = 'rgba(245,235,210,0.6)';
        ctx.fillRect(b.x+1,by,b.w-2,2);
        // Spine detail
        if(b.w>11){
          ctx.fillStyle = 'rgba(255,255,255,0.08)';
          ctx.fillRect(b.x+2,by+b.h*0.2,b.w-4,1);
          ctx.fillRect(b.x+2,by+b.h*0.8,b.w-4,1);
        }
        // Shadow between books
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fillRect(b.x+b.w-1,by,1,b.h);
      }
    });
  });
}

function drawCandle(x, groundY){
  // Wax
  const candleG = ctx.createLinearGradient(x-5,0,x+5,0);
  candleG.addColorStop(0,'#e8d8b0');
  candleG.addColorStop(0.5,'#f5ede0');
  candleG.addColorStop(1,'#d8c898');
  ctx.fillStyle = candleG;
  ctx.fillRect(x-5, groundY-28, 10, 28);
  // Wick
  ctx.strokeStyle = '#4a2808';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(x,groundY-28);
  ctx.lineTo(x-1,groundY-32);
  ctx.stroke();
  // Flame
  const flickX = Math.sin(petalAngle*3)*1.5;
  const flickY = 0.8+Math.abs(Math.sin(petalAngle*4))*0.3;
  ctx.save();
  const flameG = ctx.createRadialGradient(x+flickX,groundY-36,1,x+flickX,groundY-34,7*flickY);
  flameG.addColorStop(0,'rgba(255,255,200,0.95)');
  flameG.addColorStop(0.4,'rgba(255,180,50,0.85)');
  flameG.addColorStop(0.8,'rgba(255,100,20,0.6)');
  flameG.addColorStop(1,'rgba(255,80,0,0)');
  ctx.fillStyle = flameG;
  ctx.beginPath();
  ctx.ellipse(x+flickX,groundY-35,4,7*flickY,flickX*0.1,0,Math.PI*2);
  ctx.fill();
  // Glow
  ctx.fillStyle = 'rgba(255,180,50,0.06)';
  ctx.beginPath();
  ctx.arc(x,groundY-34,18,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function shadeColor(col, amount){
  const num = parseInt(col.slice(1),16);
  const r = Math.min(255,Math.max(0,(num>>16)+amount));
  const g = Math.min(255,Math.max(0,((num>>8)&0xff)+amount));
  const b = Math.min(255,Math.max(0,(num&0xff)+amount));
  return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

// ===== ANIMATION LOOP =====
function animate(){
  petalAngle += 0.02;
  drawScene();
  animFrame = requestAnimationFrame(animate);
}

// ===== CSS SAKURA PETALS =====
function spawnPetal(){
  const p=document.createElement('div');
  p.className='sakura-petal';
  const dur=9+Math.random()*10;
  const startX=Math.random()*110-5;
  const drift=(Math.random()-.5)*120;
  const rot=Math.random()*1080-540;
  p.style.cssText=`left:${startX}vw;top:-15px;animation-duration:${dur}s;--px:${drift}px;--pr:${rot}deg;transform:rotate(${Math.random()*360}deg);`;
  document.body.appendChild(p);
  setTimeout(()=>{p.remove();spawnPetal();},dur*1000+500);
}
for(let i=0;i<6;i++) setTimeout(spawnPetal,i*1800);

// ===== TYPEWRITER =====
const fullText=[
  {type:'p',text:'–Ø —á–∏—Ç–∞–ª —Ç–µ –∂–µ –∫–Ω–∏–≥–∏, —á—Ç–æ –∏ —Ç—ã ‚Äî –Ω–µ –ø–æ—Ç–æ–º—É —á—Ç–æ –º–Ω–µ –±—ã–ª–æ –Ω–µ—á–µ–≥–æ —á–∏—Ç–∞—Ç—å. –ê –ø–æ—Ç–æ–º—É —á—Ç–æ —Ö–æ—Ç–µ–ª –≤–∏–¥–µ—Ç—å –º–∏—Ä —Ç–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏.'},
  {type:'p',text:'–•–æ—Ç–µ–ª –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ —Å—Ç—Ä–æ—á–∫–∏ –∑–∞—Å—Ç–∞–≤–ª—è—é—Ç —Ç–µ–±—è –∑–∞–º–∏—Ä–∞—Ç—å, –∫–∞–∫–∏–µ –≥–µ—Ä–æ–∏ –∂–∏–≤—É—Ç –≤ —Ç–≤–æ–µ–π –≥–æ–ª–æ–≤–µ, –∫–∞–∫–∏–µ —Å–ª–æ–≤–∞ —Ç—ã –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ—à—å –ø–æ –Ω–æ—á–∞–º.'},
  {type:'ornament',text:'¬∑ ¬∑ ¬∑'},
  {type:'p',text:'–í –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–µ –µ—Å—Ç—å –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –¥–≤–æ–µ –Ω–∞–∫–æ–Ω–µ—Ü –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –ø—Ä–∏—Ç–≤–æ—Ä—è—Ç—å—Å—è. –ö–æ–≥–¥–∞ —Å–ª–æ–≤–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –∏ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Å—Ç–Ω–æ—Å—Ç—å.'},
  {type:'p',text:'–í–æ—Ç –º–æ–π —Ç–∞–∫–æ–π –º–æ–º–µ–Ω—Ç.'},
  {type:'p',text:'–¢—ã ‚Äî —Å–∞–º–∞—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä—É—é —è –∫–æ–≥–¥–∞-–ª–∏–±–æ –≤—Å—Ç—Ä–µ—á–∞–ª. –ò —è —Ö–æ—á—É –∑–Ω–∞—Ç—å, —á–µ–º –æ–Ω–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è. –í–º–µ—Å—Ç–µ.'},
];
let typeStarted=false;
function startTypewriter(){
  if(typeStarted)return; typeStarted=true;
  const target=document.getElementById('typeTarget');
  const cursor=document.getElementById('cursor');
  let sIdx=0,cIdx=0,currentEl=null;
  function typeNext(){
    if(sIdx>=fullText.length){cursor.remove();document.getElementById('psHint').classList.add('show');return;}
    const seg=fullText[sIdx];
    if(cIdx===0){
      if(seg.type==='ornament'){
        const o=document.createElement('div');o.className='ornament';o.textContent=seg.text;
        target.appendChild(o);sIdx++;cIdx=0;setTimeout(typeNext,400);return;
      }
      if(sIdx>0){const br=document.createElement('p');br.style.marginTop='14px';target.appendChild(br);currentEl=br;}
      else{currentEl=document.createElement('span');target.appendChild(currentEl);}
      target.parentNode.appendChild(cursor);
    }
    if(cIdx<seg.text.length){
      currentEl.textContent+=seg.text[cIdx++];
      const ch=seg.text[cIdx-1];
      setTimeout(typeNext,ch==='.'||ch===','||ch==='‚Äî'?40:10+Math.random()*8);
    } else {sIdx++;cIdx=0;setTimeout(typeNext,150);}
  }
  setTimeout(typeNext,800);
}

// ===== HOLD PS =====
let holdTimer=null,psOpen=false;
function startHold(){if(psOpen)return;holdTimer=setTimeout(()=>{document.getElementById('ps-overlay').classList.add('show');psOpen=true;},900);}
function endHold(){clearTimeout(holdTimer);}
function closePS(e){e.stopPropagation();document.getElementById('ps-overlay').classList.remove('show');psOpen=false;}

// ===== INTRO =====
let started=false;
function begin(){
  if(started)return;started=true;
  document.getElementById('intro').classList.add('out');
  setTimeout(()=>{
    document.getElementById('intro').style.display='none';
    document.getElementById('bgCanvas').classList.add('on');
    document.getElementById('page').classList.add('on');
    animate();
    setTimeout(()=>{
      document.getElementById('lw').classList.add('in');
      startTypewriter();
      setTimeout(()=>document.getElementById('qs').classList.add('in'),3800);
    },600);
  },1400);
}
setTimeout(()=>{if(!started)begin();},6000);

// ===== TAP (no hearts ‚Äî removed) =====
function onTap(e){
  if(psOpen)return;
  // Subtle sparkle only ‚Äî a small light dot
  const s=document.createElement('div');
  s.style.cssText=`position:fixed;left:${e.clientX-3}px;top:${e.clientY-3}px;width:6px;height:6px;border-radius:50%;background:rgba(255,220,160,0.8);pointer-events:none;z-index:900;animation:sparkFade 0.6s ease-out forwards;`;
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),700);
}
// Inject sparkFade
const sparkStyle=document.createElement('style');
sparkStyle.textContent='@keyframes sparkFade{0%{opacity:1;transform:scale(1);}100%{opacity:0;transform:scale(2.5);}}';
document.head.appendChild(sparkStyle);

// ===== NO BUTTON =====
let noTaps=0;
const noBtn=document.getElementById('btnNo');
const noZones=[
  ()=>{noBtn.style.cssText='position:absolute;left:8px;bottom:8px;right:auto;top:auto;transform:none;';},
  ()=>{noBtn.style.cssText='position:absolute;right:8px;bottom:8px;left:auto;top:auto;transform:none;';},
  ()=>{noBtn.style.cssText='position:absolute;left:8px;top:8px;right:auto;bottom:auto;transform:none;';},
];
function handleNo(e){
  e.stopPropagation();noTaps++;
  if(noTaps<=3){noZones[(noTaps-1)%noZones.length]();}
  else shatterNo();
}
function shatterNo(){
  const r=noBtn.getBoundingClientRect();
  const cx=r.left+r.width/2,cy=r.top+r.height/2;
  for(let i=0;i<12;i++){
    const s=document.createElement('div');s.className='shard-p';
    const angle=(i/12)*Math.PI*2,dist=60+Math.random()*110;
    s.style.cssText=`left:${cx-15+(Math.random()-.5)*25}px;top:${cy-7+(Math.random()-.5)*14}px;width:${18+Math.random()*18}px;height:${7+Math.random()*7}px;background:rgba(255,255,255,0.2);--sx:${Math.cos(angle)*dist}px;--sy:${Math.sin(angle)*dist}px;--sr:${(Math.random()-.5)*400}deg;animation-duration:0.75s;`;
    document.body.appendChild(s);setTimeout(()=>s.remove(),850);
  }
  noBtn.style.transition='opacity 0.25s';noBtn.style.opacity='0';
  setTimeout(()=>noBtn.remove(),300);
}

// ===== YES =====
function handleYes(e){
  e.stopPropagation();
  // Big sakura bloom
  for(let i=0;i<50;i++){
    setTimeout(()=>{
      const b=document.createElement('div');b.className='bloom-petal';
      const wW=W*0.82,wX=(W-wW)/2,wY=H*0.04;
      b.style.cssText=`left:${wX+Math.random()*wW}px;top:${wY}px;animation-duration:${3+Math.random()*3}s;--bx:${(Math.random()-.5)*200}px;--br:${Math.random()*1080}deg;`;
      document.body.appendChild(b);setTimeout(()=>b.remove(),7000);
    },i*60);
  }
  // Confetti (gold/sakura tones)
  const cols=['#c8922a','#ddb96a','#ffb3cf','#ffd6e7','#f5ede0','#e8c898'];
  for(let i=0;i<70;i++){
    const c=document.createElement('div');c.className='confetti-p';
    const sz=5+Math.random()*6;
    c.style.cssText=`left:${Math.random()*100}vw;top:-10px;width:${sz}px;height:${sz}px;border-radius:${Math.random()>.5?'50%':'2px'};background:${cols[Math.floor(Math.random()*cols.length)]};animation-duration:${1.8+Math.random()*2.2}s;animation-delay:${Math.random()*0.5}s;--cr:${(Math.random()-.5)*800}deg;`;
    document.body.appendChild(c);setTimeout(()=>c.remove(),4500);
  }
  setTimeout(()=>document.getElementById('yes-screen').classList.add('on'),900);
}

// ===== INIT =====
resize();
</script>
</body>
</html>
